const CANVAS_SIZE={w:1024,h:576},JSON_ROI_SIZE={w:640,h:360},CENTER={x:CANVAS_SIZE.w/2,y:CANVAS_SIZE.h/2},POLY_DEFAULT_SIZE=200,SELECTED_FILL="rgba(255,235,59,0.75)",TRANSPARENT="rgba(255,235,59,0.5)",ICONS_URL=["https://icons.getbootstrap.com/assets/icons/x-circle-fill.svg","https://icons.getbootstrap.com/assets/icons/plus-circle.svg"];let roiJsonFiles=[],roiJsonIndex=-1;const save_el=document.querySelector("#id_saved"),roi_json_el=document.querySelector("#id_json_roi");let loading_el=document.querySelector("#id_loading");const assign_modal_el=document.querySelector("#id_assign_modal"),assign_modal=new bootstrap.Modal(assign_modal_el),canvas_el=document.querySelector("#id-camera-roi"),canvas=new fabric.Canvas(canvas_el,{width:CANVAS_SIZE.w,height:CANVAS_SIZE.h}),ICONS={};let savedPolygons=[];async function load_saved(){var e;save_el&&(e=JSON.parse(save_el.innerText),Array.isArray(e))&&add_saved(e)}function add_saved(e){e.forEach(e=>{var t=document.querySelector(`button[data-type="${e.type}"]`).dataset.label,o=e.points.map(e=>({x:parseInt(CANVAS_SIZE.w*e.x/1e5),y:parseInt(CANVAS_SIZE.h*e.y/1e5)})),n={left:Math.min(...o.map(e=>e.x)),top:Math.min(...o.map(e=>e.y))};poly_add(e.id,e.type,t,e.value,o,n,!1)})}async function init_icons(){(await Promise.all(ICONS_URL.map(e=>fetch(e).then(e=>e.text())))).forEach((e,t)=>{var t=ICONS_URL[t].split("/").pop().replace(".svg",""),e=encodeURIComponent(e).replace(/'/g,"%27").replace(/"/g,"%22"),o=document.createElement("img");o.src="data:image/svg+xml,"+e,ICONS[t]=o}),await load_saved(),loading_el.nextElementSibling.classList.remove("d-none"),loading_el.remove(),loading_el=null}function update_polygon_fills(){var e=canvas.getActiveObject();const o=new Set;e&&("polygon"===e.type?o.add(e):"activeSelection"===e.type&&e.getObjects().forEach(e=>{"polygon"===e.type&&o.add(e)})),canvas.getObjects("polygon").forEach(e=>{var t=o.has(e);!t&&e._editing&&e._toggle_editing(),e.set("fill",t?SELECTED_FILL:TRANSPARENT)}),canvas.requestRenderAll()}function remove_nearest_point(n,a){var r=n.points;if(r&&0!==r.length&&!(r.length<=3)){var s=n.calcTransformMatrix();let t=-1,o=1/0;for(let e=0;e<r.length;e++){var l=fabric.util.transformPoint(new fabric.Point(r[e].x-n.pathOffset.x,r[e].y-n.pathOffset.y),s),i=l.x-a.x,l=l.y-a.y,i=i*i+l*l;i<o&&(o=i,t=e)}t<0||(r.splice(t,1),n.set({points:r,controls:fabric.controlsUtils.createPolyControls(n)}),n.setCoords(),canvas.requestRenderAll())}}function index_of_longest_edge(t){var o=t.length;if(o<2)return-1;let n=-1,a=0;for(let e=0;e<o;e++){var r=(e+1)%o,s=t[r].x-t[e].x,r=t[r].y-t[e].y,s=s*s+r*r;s>n&&(n=s,a=e)}return a}function add_point_on_longest_edge(e){var t,o,n=e.points;!n||n.length<2||(o=index_of_longest_edge(n))<0||(t=(o+1)%n.length,o={x:(n[o].x+n[t].x)/2,y:(n[o].y+n[t].y)/2},n.splice(t,0,o),e.set({controls:fabric.controlsUtils.createPolyControls(e)}),e.setCoords(),canvas.requestRenderAll())}function render_icon(s){return function(e,t,o,n,a){var r=this.cornerSize;e.save(),e.translate(t,o),e.rotate(fabric.util.degreesToRadians(a.angle)),e.drawImage(s,-r/2,-r/2,r,r),e.restore()}}function delete_object(e,t){var o;confirm(gettext("Haqiqatda o'chirishni xohlaysizmi? Agar AI uchun rasmlar belgilangan bo'lsa, o'chirish mumkin emas."))&&((o=t.target.canvas).remove(t.target),o.requestRenderAll())}function assign_id(e){assign_modal.show()}function poly_add(e,t,o,n="",a=null,r=null,s=!0){a=a||[{x:0,y:0},{x:POLY_DEFAULT_SIZE,y:0},{x:POLY_DEFAULT_SIZE,y:POLY_DEFAULT_SIZE},{x:0,y:POLY_DEFAULT_SIZE}],r=r||{left:CENTER.x-POLY_DEFAULT_SIZE/2,top:CENTER.y-POLY_DEFAULT_SIZE/2};const l=new fabric.Polygon(a,{left:r.left,top:r.top,fill:TRANSPARENT,strokeWidth:3,stroke:"grey",objectCaching:!1,transparentCorners:!1,cornerColor:"blue"});l._id=e||crypto.randomUUID(),l._editing=!0,l._type=t,l._label=o,l._value=n,l._toggle_editing=function(){l._editing=!l._editing,l._editing?(l.cornerStyle="circle",l.cornerColor="rgba(0,0,255,0.5)",l.hasBorders=!1,l.controls=fabric.controlsUtils.createPolyControls(l)):(l.cornerColor="blue",l.cornerStyle="rect",l.hasBorders=!0,l.controls=fabric.controlsUtils.createObjectDefaultControls(),l.controls.deleteControl=new fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:delete_object,render:render_icon(ICONS["x-circle-fill"]),cornerSize:24}),l.controls.assignControl=new fabric.Control({x:.5,y:-.5,offsetY:16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:function(e,t){assign_id(t.target)},render:render_icon(ICONS["plus-circle"]),cornerSize:24})),l.setCoords()},l._toggle_editing(),l._render_super=l._render,l._render=function(e){var t=l._render_super(e);return e.font="24px Arial",e.fillStyle="#000",e.textAlign="center",e.fillText(this._value,0,0),t},l.on("mousedblclick",()=>{l._toggle_editing(),canvas.requestRenderAll()}),canvas.add(l),s&&canvas.setActiveObject(l)}function load_roi_json(e,t){var o;e&&((o=new FileReader).onload=e=>{try{let t=[];JSON.parse(e.target.result).forEach(e=>{t.push({type:0,value:e.id,points:e.points.map(e=>({x:parseInt(1e5*e[0]/JSON_ROI_SIZE.w),y:parseInt(1e5*e[1]/JSON_ROI_SIZE.h)}))})}),add_saved(t)}catch(e){alert("JSON parse error: "+e.message)}},o.onerror=()=>{alert("An error occurred while reading the json file.")},o.readAsText(e,"utf-8"))}function load_poly_data(){const n=[];return canvas.getObjects("polygon").forEach(t=>{const o=t.calcTransformMatrix();var e=t.points.map(e=>{e=new fabric.Point(e.x-t.pathOffset.x,e.y-t.pathOffset.y);return fabric.util.transformPoint(e,o)}).map(e=>({x:parseInt(1e5*e.x/CANVAS_SIZE.w),y:parseInt(1e5*e.y/CANVAS_SIZE.h)}));n.push({id:t._id,type:t._type,value:t._value.toString().trim(),points:e})}),n}canvas.on("selection:created",update_polygon_fills),canvas.on("selection:updated",update_polygon_fills),canvas.on("selection:cleared",update_polygon_fills),assign_modal_el.addEventListener("show.bs.modal",e=>{var t=canvas.getActiveObject();assign_modal_el.querySelector("form label").innerText=t._label,assign_modal_el.querySelector(".modal-title").innerText=t._label,assign_modal_el.querySelector("form input").value=t._value}),assign_modal_el.addEventListener("shown.bs.modal",e=>{assign_modal_el.querySelector("form input").focus()}),assign_modal_el.querySelector("form").addEventListener("submit",e=>{e.preventDefault(),canvas.getActiveObject()._value=assign_modal_el.querySelector("form input").value,canvas.requestRenderAll(),assign_modal.hide()}),canvas.on("mouse:down",function(e){var e=e.e,t=canvas.getActiveObject();t&&"polygon"===t.type&&t._editing&&(e.shiftKey?remove_nearest_point(t,canvas.getPointer(e)):e.altKey&&add_point_on_longest_edge(t))}),window.addEventListener("keydown",e=>{var t="ArrowLeft"===e.code,o="ArrowRight"===e.code;"Space"===e.code?(e=canvas.getActiveObject())&&"polygon"===e.type&&assign_id(e):!t&&!o||(e=roiJsonIndex+(t?-1:1))<-1||e>=roiJsonFiles.length||(-1===roiJsonIndex&&(savedPolygons=load_poly_data()),canvas.getObjects("polygon").forEach(e=>canvas.remove(e)),-1===e?(add_saved(savedPolygons),roi_json_el.innerHTML=""):(roi_json_el.innerHTML=roiJsonFiles[e].name,load_roi_json(roiJsonFiles[e])),roiJsonIndex=e,canvas.requestRenderAll())}),document.querySelectorAll("#id_buttons button").forEach(t=>{t.addEventListener("click",e=>{loading_el?alert("Loading..."):poly_add(void 0,parseInt(t.dataset.type),t.dataset.label)})}),document.querySelector("#id_btn_save").addEventListener("click",e=>{var t=load_poly_data();fetch("",{method:"POST",headers:{"Content-Type":"application/json",...csrf_header()},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{const o=[e.message];e.errors&&(o.push(""),e.errors.forEach(t=>{Object.keys(t).forEach(e=>{o.push(e),t[e].forEach(e=>o.push("- "+e))})})),alert(o.join("\n"))}).catch(e=>{alert("Failed to Save!")})}),document.querySelector("#id_input_load_json").addEventListener("change",e=>{roiJsonFiles=Array.from(e.target.files||[]),-1!==roiJsonIndex&&(canvas.getObjects("polygon").forEach(e=>canvas.remove(e)),add_saved(savedPolygons),roiJsonIndex=-1,roi_json_el.innerHTML=""),alert("Loaded "+roiJsonFiles.length)}),init_icons();