const CANVAS_SIZE={w:1024,h:576},SELECTED_FILL="rgba(27,94,32,0.75)",TRANSPARENT="rgba(255,235,59,0.5)",editable="true"===document.currentScript.dataset.edit.toLowerCase(),save_el=document.querySelector("#id_saved"),marked_el=document.querySelector("#id_marked"),next_btn=document.querySelector("#id_next_btn"),yes_btn=document.querySelector("#id_yes"),no_btn=document.querySelector("#id_no"),canvas_el=document.querySelector("#id-ai-stall-mark"),canvas=new fabric.Canvas(canvas_el,{width:CANVAS_SIZE.w,height:CANVAS_SIZE.h});canvas.selection=!1;let marked={};if(marked_el){const a=JSON.parse(marked_el.innerText);a&&Array.isArray(a)&&a.forEach(e=>{marked[e.id]=e.is_occupied})}function load_saved(){var e;save_el&&(e=JSON.parse(save_el.innerText),Array.isArray(e))&&e.forEach(e=>{var t=e.points.map(e=>({x:parseInt(CANVAS_SIZE.w*e.x/1e5),y:parseInt(CANVAS_SIZE.h*e.y/1e5)})),n={left:Math.min(...t.map(e=>e.x)),top:Math.min(...t.map(e=>e.y))};0===e.type&&poly_add(e.id,e.type,e.value,t,n,!1)})}function poly_add(e,t,n,a,o){const r=new fabric.Polygon(a,{left:o.left,top:o.top,fill:TRANSPARENT,strokeWidth:3,stroke:"grey",objectCaching:!1,transparentCorners:!1,cornerColor:"blue",selectable:!1,hasControls:!1,hasBorders:!1,evented:!0,hoverCursor:"pointer"});function s(){r.set("fill",r._is_occupied?SELECTED_FILL:TRANSPARENT)}r._is_occupied=void 0!==marked[e]&&marked[e],r._id=e,r._type=t,r._value=n,editable&&r.on("mousedown",function(){r._is_occupied=!r._is_occupied,s(),canvas.requestRenderAll()}),s(),canvas.add(r)}function save(e,t,n){fetch("",{method:"POST",headers:{"Content-Type":"application/json",...csrf_header()},body:JSON.stringify({id:e,data:t})}).then(e=>e.json()).then(e=>{var t=[e.message];e.errors&&(t.push(""),t.push(JSON.stringify(e.errors)),alert(t.join("\n"))),e.success&&n&&n()}).catch(e=>alert(e))}function save_yesno(e,t){save(e,t,()=>{window.location.reload()})}next_btn?next_btn.addEventListener("click",function(){const t=[];canvas.getObjects("polygon").forEach(e=>{t.push({id:e._id,is_occupied:e._is_occupied})}),save(next_btn.dataset.id,t,()=>{next_btn.dataset.href?window.location.href=next_btn.dataset.href:window.location.reload()})}):yes_btn&&no_btn&&(yes_btn.addEventListener("click",()=>{save_yesno(yes_btn.dataset.id,!0)}),no_btn.addEventListener("click",()=>{save_yesno(no_btn.dataset.id,!1)})),load_saved(),document.addEventListener("keyup",function(e){let t="";var n;"ArrowLeft"===e.key||"a"===e.key?t="key-left":"ArrowRight"!==e.key&&"d"!==e.key||(t="key-right"),0<t.length&&(e=document.querySelector(`button.${t}, a.`+t))&&(n=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}),e.dispatchEvent(n))});